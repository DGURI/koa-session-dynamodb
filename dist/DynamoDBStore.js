"use strict";exports.__esModule=true;exports.default=void 0;var _awsSdk=_interopRequireDefault(require("aws-sdk"));var _constants=require("./constants");var _utils=require("./utils");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}function _extends(){_extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return _extends.apply(this,arguments)}class DynamoDBStore{constructor(options={},callback=_constants.DEFAULT_CALLBACK){(0,_utils.debug)("Initializing store",options);this.setOptions(options);const dynamoConfig=options.dynamoConfig||{};this.dynamoService=new _awsSdk.default.DynamoDB(_extends({},dynamoConfig,{apiVersion:_constants.API_VERSION}));this.documentClient=new _awsSdk.default.DynamoDB.DocumentClient({service:this.dynamoService});this.createTableIfDontExists(callback)}setOptions(options){const{table={},dynamoConfig={}}=options;const{name=_constants.DEFAULT_TABLE_NAME,hashPrefix=_constants.DEFAULT_HASH_PREFIX,hashKey=_constants.DEFAULT_HASH_KEY,ttlKey=_constants.DEFAULT_TTL_KEY,readCapacityUnits=_constants.DEFAULT_RCU,writeCapacityUnits=_constants.DEFAULT_WCU,useDynamodbTtl=_constants.DEFAULT_USE_DYNAMODB_TTL}=table;Object.assign(this,{tableName:name,hashPrefix,hashKey,ttlKey,readCapacityUnits:Number(readCapacityUnits),writeCapacityUnits:Number(writeCapacityUnits),isLocal:dynamoConfig.region==="local",useDynamodbTtl})}isTableCreated(){var _this=this;return _asyncToGenerator(function*(){try{yield _this.dynamoService.describeTable({TableName:_this.tableName}).promise();return true}catch(tableNotFoundError){return false}})()}createTable(){const params={TableName:this.tableName,KeySchema:[{AttributeName:this.hashKey,KeyType:"HASH"}],AttributeDefinitions:[{AttributeName:this.hashKey,AttributeType:"S"}],ProvisionedThroughput:{ReadCapacityUnits:this.readCapacityUnits,WriteCapacityUnits:this.writeCapacityUnits}};return this.dynamoService.createTable(params).promise()}setTtlField(){var _this2=this;return _asyncToGenerator(function*(){const{tableName,ttlKey}=_this2;const params={TableName:tableName,TimeToLiveSpecification:{AttributeName:ttlKey,Enabled:_this2.useDynamodbTtl}};return _this2.dynamoService.updateTimeToLive(params).promise()})()}createTableIfDontExists(callback){var _this3=this;return _asyncToGenerator(function*(){try{const exists=yield _this3.isTableCreated();if(exists){(0,_utils.debug)(`Table ${_this3.tableName} already exists`);if(!_this3.isLocal){yield _this3.setTtlField()}}else{(0,_utils.debug)(`Creating table ${_this3.tableName}...`);yield _this3.createTable();if(!_this3.isLocal){yield _this3.setTtlField()}}callback()}catch(createTableError){(0,_utils.debug)(`Error creating table ${_this3.tableName}`,createTableError);callback(createTableError)}})()}get(id){var _this4=this;return _asyncToGenerator(function*(){const{tableName,hashKey}=_this4;try{return yield _this4.documentClient.get({Key:{[hashKey]:id},TableName:tableName}).promise().then(result=>result.Item.session)}catch(err){throw new Error("Unable to get session.")}})()}set(id,session,maxAge){var _this5=this;return _asyncToGenerator(function*(){const{tableName,hashKey,ttlKey}=_this5;const Item={session};Item[hashKey]=id;Item[ttlKey]=(0,_utils.toSecondsEpoch)(_this5.getExpirationDate(maxAge));const params={TableName:tableName,Item};return _this5.documentClient.put(params).promise()})()}getExpirationDate(maxAge){const expirationDate=Date.now()+maxAge;return new Date(expirationDate)}destroy(id){var _this6=this;return _asyncToGenerator(function*(){const{tableName,hashKey}=_this6;return _this6.documentClient.delete({Key:{[hashKey]:id},TableName:tableName}).promise()})()}}exports.default=DynamoDBStore;